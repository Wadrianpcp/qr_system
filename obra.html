<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Bipagem na Obra</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #333;
    }
    #camera-preview {
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      border: 2px solid #ccc;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 10px 5px;
    }
    #ultimos-registros {
      margin-top: 30px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>Bipagem na Obra</h1>

  <input type="text" id="inputQR" placeholder="Escaneie ou digite o QR Code" autofocus>
  <input type="text" id="inputUsuario" placeholder="Usuário">
  <button onclick="registrarQR()">Registrar</button>
  <button onclick="window.location.href='/registros_obra'">Ver Registros da Obra</button>
  <button onclick="iniciarCamera()">Ativar Câmera</button>

  <video id="camera-preview" playsinline></video>

  <div id="ultimos-registros">
    <h3>Últimos QR Codes Bipados:</h3>
    <ul id="listaRegistros"></ul>
  </div>

  <audio id="audio-ok" src="ok.mp3" preload="auto"></audio>
  <audio id="audio-erro" src="erro.mp3" preload="auto"></audio>

  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <script>
    const inputQR = document.getElementById('inputQR');
    const inputUsuario = document.getElementById('inputUsuario');
    const listaRegistros = document.getElementById('listaRegistros');
    const audioOk = document.getElementById('audio-ok');
    const audioErro = document.getElementById('audio-erro');

    function registrarQR() {
      const codigo = inputQR.value.trim();
      const usuario = inputUsuario.value.trim();

      if (!codigo || !usuario) {
        alert('Informe o QR Code e o usuário.');
        return;
      }

      fetch('/registrar_qr_obra', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({codigo_qr: codigo, usuario: usuario})
      })
      .then(res => res.json())
      .then(data => {
        if (data.mensagem) {
          audioOk.play();
          inputQR.value = '';
          carregarUltimosRegistros();
        } else {
          audioErro.play();
          alert(data.erro || 'Erro ao registrar.');
        }
      });
    }

    function carregarUltimosRegistros() {
      fetch('/listar_qr_obra')
        .then(res => res.json())
        .then(dados => {
          listaRegistros.innerHTML = '';
          dados.slice(0, 10).forEach(r => {
            const li = document.createElement('li');
            li.textContent = `${r.codigo_qr} - ${r.usuario} - ${r.data_hora}`;
            listaRegistros.appendChild(li);
          });
        });
    }

    function iniciarCamera() {
      const codeReader = new ZXing.BrowserMultiFormatReader();
      codeReader.decodeFromVideoDevice(null, 'camera-preview', (result, err) => {
        if (result) {
          inputQR.value = result.text;
          registrarQR();
          codeReader.reset();
        }
      });
    }

    carregarUltimosRegistros();
  </script>
</body>
</html>
